---
import Layout from '../layouts/Layout.astro';
import { getTranslations, getCurrentLocale } from '../utils/i18n';

const currentUrl = new URL(Astro.request.url);
const currentLocale = getCurrentLocale(currentUrl);
const t = getTranslations(currentLocale);
---

<Layout 
  title={t.nav.submit}
  description={t.submit.subtitle}
>
  <section class="py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-2xl mx-auto">
      <!-- Header -->
      <div class="text-center mb-12">
        <h1 class="text-4xl font-bold text-gray-900 mb-4">
          {t.submit.title}
        </h1>
        <p class="text-xl text-gray-600">
          {t.submit.subtitle}
        </p>
      </div>

      <!-- Form -->
      <div class="bg-white rounded-xl shadow-lg p-8">
        <form class="space-y-6" id="submit-form">
          <!-- Project Name -->
          <div>
            <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
              {t.submit.form.name}
            </label>
            <input 
              type="text" 
              id="name" 
              name="name"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-colors"
              placeholder={t.submit.form.namePlaceholder}
            />
          </div>

          <!-- Description -->
          <div>
            <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
              {t.submit.form.description}
            </label>
            <textarea 
              id="description" 
              name="description"
              rows="4"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-colors resize-vertical"
              placeholder={t.submit.form.descriptionPlaceholder}
            ></textarea>
          </div>

          <!-- Image URL -->
          <div>
            <label for="image" class="block text-sm font-medium text-gray-700 mb-2">
              {t.submit.form.image}
            </label>
            <input 
              type="url" 
              id="image" 
              name="image"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-colors"
              placeholder={t.submit.form.imagePlaceholder}
            />
          </div>

          <!-- GitHub URL -->
          <div>
            <label for="github" class="block text-sm font-medium text-gray-700 mb-2">
              {t.submit.form.github}
            </label>
            <input 
              type="url" 
              id="github" 
              name="github"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-colors"
              placeholder={t.submit.form.githubPlaceholder}
            />
          </div>

          <!-- Profit Share -->
          <div>
            <label for="profitShare" class="block text-sm font-medium text-gray-700 mb-2">
              {t.submit.form.profitShare}
            </label>
            <input 
              type="text" 
              id="profitShare" 
              name="profitShare"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-colors"
              placeholder={t.submit.form.profitSharePlaceholder}
            />
          </div>

          <!-- Contact -->
          <div>
            <label for="contact" class="block text-sm font-medium text-gray-700 mb-2">
              {t.submit.form.contact}
            </label>
            <input 
              type="text" 
              id="contact" 
              name="contact"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-colors"
              placeholder={t.submit.form.contactPlaceholder}
            />
          </div>

          <!-- Submit Button -->
          <div class="pt-4">
            <button 
              type="submit"
              class="w-full bg-primary-600 hover:bg-primary-700 text-white font-semibold py-4 px-6 rounded-lg transition-colors shadow-lg hover:shadow-xl transform hover:-translate-y-1 duration-300"
            >
              {t.submit.form.submit}
            </button>
          </div>

          <!-- Success Message -->
          <div id="success-message" class="hidden bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg">
            {currentLocale === 'en' 
              ? 'Thank you for submitting your project! It will be reviewed and added to the directory.'
              : 'Спасибо за отправку вашего проекта! Он будет рассмотрен и добавлен в каталог.'
            }
          </div>

          <!-- Error Message -->
          <div id="error-message" class="hidden bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg">
            {currentLocale === 'en'
              ? 'Error sending form. Please try again or contact us directly.'
              : 'Ошибка отправки формы. Попробуйте снова или свяжитесь с нами напрямую.'
            }
          </div>
        </form>
      </div>
    </div>
  </section>
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('submit-form') as HTMLFormElement;
    const submitButton = form?.querySelector('button[type="submit"]') as HTMLButtonElement;
    const successMessage = document.getElementById('success-message');
    const errorMessage = document.getElementById('error-message');
    
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (!submitButton) return;
      
      // Disable button and show loading state
      const originalText = submitButton.textContent;
      submitButton.disabled = true;
      submitButton.textContent = '⏳ Sending...';
      
      try {
        const formData = new FormData(form);
        
        // Prepare email body
        const emailBody = `
New Project Submission

Project Name: ${formData.get('name')}
Description: ${formData.get('description')}
Image URL: ${formData.get('image') || 'Not provided'}
GitHub URL: ${formData.get('github')}
Profit Share: ${formData.get('profitShare')}
Contact: ${formData.get('contact')}
        `.trim();

        // Send email using Web3Forms
        const response = await fetch('https://api.web3forms.com/submit', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({
            access_key: '9afd4d23-26b5-4ca5-be6b-0f6d15544990',
            subject: `ProShare: New Project Submission - ${formData.get('name')}`,
            from_name: 'ProShare Website',
            to_email: 'netemtem@gmail.com',
            message: emailBody
          })
        });

        const result = await response.json();

        if (result.success) {
          form.style.display = 'none';
          successMessage?.classList.remove('hidden');
          successMessage?.scrollIntoView({ behavior: 'smooth' });
        } else {
          throw new Error('Failed to send');
        }
      } catch (error) {
        console.error('Form submission error:', error);
        errorMessage?.classList.remove('hidden');
        errorMessage?.scrollIntoView({ behavior: 'smooth' });
        submitButton.disabled = false;
        submitButton.textContent = originalText;
      }
    });
  });
</script>